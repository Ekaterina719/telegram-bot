import logging
import random
from telegram._utils import markup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes
from telegram import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, ReplyKeyboardRemove


logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.DEBUG
)
logger = logging.getLogger(__name__)
index = 0
right = 0
que_num = 0
questions = []


async def start(update, context):
    await update.message.reply_text(
        rf"Привет! Я бот, который может помочь тебе проверить свои знания в формате заданий ОГЭ. "
        rf"Выбери по какому предмету ты хочешь пройти тест!",
        reply_markup=markup
    )


async def help_command(update, context):
    await update.message.reply_text("Я бот с тестами. Тест представляет собой последовательность из 10 вопросов"
                                    " в формате ОГЭ. После завершения, выводится количество верных ответов"
                                    " из возможных. На данный момент доступны тесты по 4 предметам:"
                                    " биологии, химии, обществознанию и географии. Удачного времяпрепровождения!")


async def ask_que(update, context: ContextTypes.DEFAULT_TYPE):
    global index
    global right
    global que_num
    global questions
    query = update.callback_query
    if index < 10:
        que_num = random.randint(0, len(questions) - 1)
        question_data = questions[que_num]
        question_text = question_data["question"]
        options = question_data["options"]
        print(question_text, options)

        button1 = InlineKeyboardButton(text=options[0], callback_data="1")
        button2 = InlineKeyboardButton(text=options[1], callback_data="2")
        button3 = InlineKeyboardButton(text=options[2], callback_data="3")
        button4 = InlineKeyboardButton(text=options[3], callback_data="4")
        buttons = InlineKeyboardMarkup(inline_keyboard=[[button1], [button2], [button3], [button4]])
        await query.message.reply_text(
            question_text, reply_markup=buttons)
    else:
        await query.message.reply_text(
            f"Спасибо за участие! Ваш результат: {right} из 10",
            reply_markup=markup)
        await context.bot.send_photo(
            query.message.chat_id, photo='cat.png'
        )
        index = 0
        right = 0


async def handle_button_click(update, context: ContextTypes.DEFAULT_TYPE):
    global index
    global right
    global que_num
    global questions
    query = update.callback_query
    data = query.data
    print(data, query)
    if data == 'ready_bio':
        questions = [
    {
        "question": "Какая система органов осуществляет освобождение клеток и тканей от конечных продуктов обмена "
                    "веществ, растворенных в воде?",
        "options": ["Иммунная", 'Кровеносная', 'Дыхательная', "Покровная"],
        "right": '2',
    },
    {
        "question": "Какая кость в скелете человека является самой крупной?",
        "options": ['Большая берцовая', 'Лучевая', 'Бедренная', 'Локтевая'],
        "right": '3',
    },
    {
        "question": "Функцию питания и роста кости в толщину выполняет?",
        "options": ['Желтый костный мозг', 'Красный костный мозг', 'Надкостница', 'Губчатое вещество'],
        "right": '3',
    },
    {
        "question": "На языке человека имеются рецепторы, воспринимающие четыре базовых вкусовых ощущения: "
                    "сладкое, кислое, соленое и?",
        "options": ['Терпкое', 'Горькое', 'Жгучее', 'Жирное'],
        "right": '2',
    },
    {
        "question": "Зрительные рецепторы расположены в оболочке глаза, которая называется",
        "options": ['Сетчаткой', 'Сосудистой', 'Роговицей', 'Радужкой'],
        "right": '1',
    },
    {
        "question": "Обонятельные рецепторы расположены в",
        "options": ['Носовой полости', 'Области гортани', 'Ротовой полости', 'Области мягкого неба'],
        "right": '1',
    },
    {
        "question": "К какому цвету избирательно чувствительны колбочки сетчатки?",
        "options": ['Серый', 'Черный', 'Синий', 'Желтый'],
        "right": '3',
    },
    {
        "question": "Внутреннее ухо человека расположено в полости кости",
        "options": ['Лобной', 'Теменной', 'Височной', 'Затылочной'],
        "right": '3',
    },
    {
        "question": "Что расположено в средней части уха?",
        "options": ['Вестибулярный аппарат', 'Стремечко', 'Слуховой нерв', 'Лабиринт'],
        "right": '2',
    },
    {
        "question": "К древнейшим людям ученые относят",
        "options": ['Австралопитека', 'Неандертальца', 'Питекантропа', 'Кроманьонца'],
        "right": '3',
    },
    {
        "question": "Как называют семейство, в которое помимо человека включены человекообразные обезьяны?",
        "options": ['Игрунковые', 'Гоминиды', 'Сумчатые', 'Лемуровые'],
        "right": '2',
    },
    {
        "question": "Какой признак класса Млекопитающие свойствен человеку?",
        "options": ['Диафрагма', 'Легочное дыхание', 'Головной и спинной мозг', 'Замкнутая кровеносная система'],
        "right": '1',
    },
    {
        "question": "Из современных человекообразных обезьян человек имеет наибольшее родство с",
        "options": ['Гиббоном', 'Шимпанзе', 'Гориллой', 'Орангутаном'],
        "right": '2',
    },
    {
        "question": "Современный человек — это прямой потомок",
        "options": ['Кроманьонцев', 'Неандертальцев', 'Синантропов', 'Питекантропов'],
        "right": '1',
    },
    {
        "question": "Строение какого органа у человека и у медузы имеет наибольшее сходство?",
        "options": ['Дыхания', 'Равновесия', 'Пищеварения', 'Кроветворения'],
        "right": '2',
    },
    {
        "question": "Какой орган у человека и кальмара сходен по строению?",
        "options": ['Сердце', 'Желудок', 'Ухо', 'Глаз'],
        "right": '4',
    },
    {
        "question": "Какой из перечисленных органов относят к органам малого таза?",
        "options": ['Сердце', 'Селезенка', 'Мочевой пузырь', 'Глаз'],
        "right": '3',
    },
    {
        "question": "В какой полости тела расположен мозжечок?",
        "options": ['Брюшная полость', 'Полость черепа', 'Грудная полость', 'Тазовая полость'],
        "right": '2',
    },
    {
        "question": "Какой из приведенных органов входит в состав системы органов дыхания?",
        "options": ['Гортань', 'Печень', 'Аорта', 'Селезенка'],
        "right": '1',
    },
    {
        "question": "К какой систематической группе класса Млекопитающие относят вид Человек разумный?",
        "options": ['Сумчатые', 'Грызуны', 'Хищные', 'Приматы'],
        "right": '4',
    },
    {
        "question": "Ведущей тканью, образующей мозг человека, является",
        "options": ['Мышечная', 'Соединительная', 'Эпителиальная', 'Нервная'],
        "right": '4',
    },
    {
        "question": "Слой, защищающий верхнюю часть зуба от механических воздействий,— это",
        "options": ['Эмаль', 'Пульпа', 'Цемент', 'Дентин'],
        "right": '1',
    },
    {
        "question": "В процессе пищеварения жиры расщепляются до",
        "options": ['Глюкозы', 'Аминокислот', 'Белков', 'Глицерина и жирных кислот'],
        "right": '4',
    },
    {
        "question": "Какой орган пищеварительного канала обладает функциями переваривания пищи?",
        "options": ['Прямая кишка', 'Пищевод', 'Глотка', 'Желудок'],
        "right": '4',
    },
    {
        "question": "Кашель возникает при раздражении рецепторов",
        "options": ['Гортани', 'Носоглотки', 'Ротовой полости', 'Носовой полости'],
        "right": '1',
    },
    {
        "question": "В каких органоидах клеток человека образуется углекислый газ, выделяемый в процессе дыхания?",
        "options": ['Лизосомы', 'Рибосомы', 'Митохондрии', 'Ядро'],
        "right": '3',
    },
    {
        "question": "Что является возбудителем гриппа?",
        "options": ['Бактерия', 'Вирус', 'Грибок', 'Простейшее'],
        "right": '2',
    },
    {
        "question": "За счет чего происходит увеличение площади кишечника?",
        "options": ['Борозд', 'Ворсинок', 'Каналов', 'Извилин'],
        "right": '2',
    },
    {
        "question": "Активной частью секрета пищеварительной железы является",
        "options": ['Фермент', 'Вода', 'Пигмент', 'Витамин'],
        "right": '1',
    },
    {
        "question": "Какой орган относят к пищеварительному каналу?",
        "options": ['Печень', 'Желудок', 'Слюнные железы', 'Поджелудочную железу'],
        "right": '2',
    },
    {
        "question": "Какое вещество начинает расщепляться под действием ферментов в ротовой полости человека?",
        "options": ['Белок', 'ДНК', 'Крахмал', 'Жир'],
        "right": '3',
    },
    {
        "question": "Желчь, вырабатываемая печенью, поступает в",
        "options": ['Пищевод', 'Желудок', 'Тонкую кишку', 'Поджелудочную железу'],
        "right": '3',
    },
    {
        "question": "Разветвленное строение в дыхательной системе имеет",
        "options": ['Трахея', 'Гортань', 'Бронх', 'Альвеола'],
        "right": '3',
    },
    {
        "question": "Что придает костям упругость?",
        "options": ['Вода', 'Белки', 'Углеводы', 'Соединения фосфора'],
        "right": '2',
    },
    {
        "question": "Какой отдел позвоночника образует соединение с костями таза?",
        "options": ['Крестцовый', 'Грудной', 'Шейный', 'Поясничный'],
        "right": '1',
    },
    {
        "question": "Самой массивной костью скелета человека является",
        "options": ['Лучевая кость', 'Плечевая кость', 'Большая берцовая кость', 'Бедренная кость'],
        "right": '4',
    },
    {
        "question": "Где в организме человека происходит разрушение эритроцитов?",
        "options": ['В печени', 'В почках', 'В поджелудочной железе', 'В легких'],
        "right": '1',
    },
    {
        "question": "Что из перечисленного входит в состав плазмы крови человека?",
        "options": ['Тромбоциты', 'Красные клетки крови', 'Сыворотка', 'Белые клетки крови'],
        "right": '3',
    },
    {
        "question": "Тромб, закупоривающий поврежденное место сосуда, образуется из сети нитей",
        "options": ['Фибриногена', 'Тромбина', 'Фибрина', 'Разрушающихся тромбоцитов'],
        "right": '3',
    },
    {
        "question": "Разрушение эритроцитов происходит в",
        "options": ['Красном костном мозге', 'Капиллярах', 'Селезенке и печени', 'Легких'],
        "right": '3',
    },
    {
        "question": "В образовании антител принимают участие",
        "options": ['Эритроциты', 'Тромбоциты', 'Фагоциты', 'Лимфоциты'],
        "right": '4',
    },
    {
        "question": "Какие клетки входят в состав лимфы?",
        "options": ['Лейкоциты', 'Эритроциты', 'Миоциты', 'Эпителиоциты'],
        "right": '1',
    },
    {
        "question": "В каком случае указана третья положительная группа крови?",
        "options": ['A(II)Rh+', 'B(III)Rh+', '0(I)Rh+', 'B(III)Rh–'],
        "right": '2',
    },
    {
        "question": "Какую функцию выполняет кровь в организме человека?",
        "options": ['Опорную', 'Рефлекторную', 'Гуморальную', 'Строительную'],
        "right": '3',
    },
    {
        "question": "Если эритроцит человека поместить в раствор с большим содержанием соли, то он",
        "options": ['Набухнет', 'Не изменится', 'Сморщится', 'Слипнется с другими'],
        "right": '3',
    },
    {
        "question": "К развитию какой болезни приводит дефицит витамина D?",
        "options": ['Цинга', 'Рахит', 'Гипотиреоз', 'Синдром Дауна'],
        "right": '2',
    },
    {
        "question": "Какая система человека активизируется при проникновении в кровь чужеродных белков?",
        "options": ['Нервная', 'Иммунная', 'Пищеварительная', 'Кровеносная'],
        "right": '2',
    },
    {
        "question": "Термин «форменные элементы» применяется при описании клеток",
        "options": ['Нервной системы', 'Кровеносной системы', 'Крови', 'Печени'],
        "right": '3',
    },
    {
        "question": "Процесс свертывания крови у человека может нарушиться при недостатке в организме",
        "options": ['Магния', 'Железа', 'Натрия', 'Кальция'],
        "right": '4',
    },
    {
        "question": "В каких клетках крови образуется оксигемоглобин?",
        "options": ['Лейкоцитах', 'Эритроцитах', 'Лимфоцитах', 'Тромбоцитах'],
        "right": '2',
    },
    {
        "question": "Тромб — это сгусток, состоящий из клеток крови и нитей",
        "options": ['Хлорофилла', 'Фибрина', 'Гемоглобина', 'Гликогена'],
        "right": '2',
    },
    {
        "question": "Эритроциты могут переносить кислород и углекислый газ, так как в их цитоплазме содержится",
        "options": ['Инсулин', 'Гемоглобин', 'Холестерин', 'Фибрин'],
        "right": '2',
    },
]
        await ask_que(update, context)
    elif data == 'ready_chem':
        questions = [
    {
        "question": "Азот и аммиак являются соответственно",
        "options": ['простым и сложным веществами', 'сложным и простым веществами', 'сложными веществами',
                    "простыми веществами"],
        "right": '1',
    },
    {
        "question": "Сложным является каждое из двух веществ:",
        "options": ['кислород и озон', 'белый фосфор и азотная кислота', 'серная кислота и кварц', 'вода и барий'],
        "right": '3',
    },
    {
        "question": "Выберите высказывание, в котором говорится о железе как о химическом элементе.",
        "options": ['Железо реагирует с хлором', 'Железо быстро ржавеет во влажном воздухе',
                    'В состав ржавчины входит железо', 'Пирит является сырьем для получения железа'],
        "right": '3',
    },
    {
        "question": "Выберите вещество, которое не проводит электрический ток.",
        "options": ['расплав хлорида натрия', 'расплав оксида кремния', 'раствор азотной кислоты', 'раствор хлорида цинка'],
        "right": '2',
    },
    {
        "question": "Выберите вещество, которое проводит электрический ток.",
        "options": ['раствор хлороводорода', 'расплав серы', 'расплав оксида кремния', 'раствор глюкозы'],
        "right": '1',
    },
    {
        "question": "Выберите вещество, которое полностью диссоциирует на ионы в водном растворе",
        "options": ['сероводород', 'глицерин', 'иодид натрия', 'этиловый спирт'],
        "right": '3',
    },
    {
        "question": "Выберите вещество, которое не относится к электролитам",
        "options": ['сера', 'cульфат меди(II)', 'гидроксид калия', 'серная кислота'],
        "right": '1',
    },
    {
        "question": "Выберите вещество, которое является сильными электролитом",
        "options": ['угольная кислота', 'сероводородная кислота', 'сахароза', 'азотная кислота'],
        "right": '4',
    },
    {
        "question": "Сложным является каждое из двух веществ",
        "options": ['вода и хлор', 'вода и водород', 'водород и кварц', 'бензол и вода'],
        "right": '4',
    },
    {
        "question": "Простым является каждое из двух веществ:",
        "options": ['кислород и метан', 'аммиак и ртуть', 'алмаз и хлор', 'медь и вода'],
        "right": '3',
    },
]
        await ask_que(update, context)
    elif data == 'ready_obsh':
        questions = [
                        {
                            "question": "Готовность покупателей приобрести товар или услугу по определенной цене — это",
                            "options": ['предложение', 'номинальная стоимость', 'прибыль', 'спрос'],
                            "right": '4',
                        },
                        {
                            "question": "В условиях рынка цены на товары",
                            "options": ['определяются спросом и предложением', 'устанавливаются государством',
                                        'определяются центральным банком', 'устанавливаются крупными производителями'],
                            "right": '1',
                        },
                        {
                            "question": "Что произойдет с ценами на товары, если предложение их при прочих равных условиях возрастет?",
                            "options": ['цены снизятся', 'цены останутся неизменными', 'цены возрастут', 'произойдет инфляционный скачок цен'],
                            "right": '1',
                        },
                        {
                            "question": "К прямым налогам относится",
                            "options": ['акциз', 'таможенная пошлина', 'налог на имущество', 'налог с продаж'],
                            "right": '3',
                        },
                        {
                            "question": "Что из перечисленного относится к факторам (ресурсам) производства?",
                            "options": ['труд', 'товары', 'обмен', 'спрос'],
                            "right": '1',
                        },
                        {
                            "question": "Доход в государственный бюджет приносит (-ят)",
                            "options": ['обслуживание государственного долга', 'дотации предприятиям', 'льготы общественным фондам', 'таможенные пошлины'],
                            "right": '4',
                        },
                        {
                            "question": "К дефициту государственного бюджета непосредственно ведет",
                            "options": ['уменьшение налоговых поступлений', 'увеличение объемов производства', 'сокращение расходов на оборону',
                                        'развитие малого бизнеса'],
                            "right": '1',
                        },
                        {
                            "question": "Что относится к основным факторам производства?",
                            "options": ['цена', 'спрос', 'предложение', 'земля'],
                            "right": '4',
                        },
                        {
                            "question": "К расходной части государственного бюджета относится",
                            "options": ['обслуживание государственного долга', 'государственная пошлина', 'акцизный сбор', 'подоходный налог'],
                            "right": '1',
                        },
                        {
                            "question": "Какое из приведенных понятий обобщает, объединяет все остальные?",
                            "options": ['транспортная инфраструктура', 'капитал', 'конвейер', 'заводской корпус'],
                            "right": '2',
                        },
                        {
                            "question": "Как называется принадлежность материальных или духовных ценностей определенным лицам?",
                            "options": ['собственность', 'ресурсы', 'капитал', 'стоимости'],
                            "right": '1',
                        },
                    ]
        await ask_que(update, context)
    elif data == 'ready_geo':
        questions = [
    {
        "question": "Как называется материк, по территории которого протекают реки Меконг и Иравади?",
        "options": ['Балтийское', 'Белое', 'Берингово', 'Черное'],
        "right": '3',
    },
    {
        "question": "Какое из перечисленных морей, омывающих побережье России, является самым большим и глубоким?",
        "options": ['Южная Америка', 'Евразия', 'Австралия', 'Африка'],
        "right": '2',
    },
    {
        "question": "Численность населения какой из перечисленных стран наименьшая?",
        "options": ['Индонезия', 'США', 'Индия', 'Австралия'],
        "right": '4',
    },
    {
        "question": "У берегов какого из перечисленных материков проходит океаническое течение Гольфстрим??",
        "options": ['Австралия', 'Южная Америка', 'Северная Америка', 'Африка'],
        "right": '3',
    },
    {
        "question": "Какая из перечисленных горных систем имеет наибольшую протяженность?",
        "options": ['Гималаи', 'Кавказ', 'Анды', 'Карпаты'],
        "right": '3',
    },
    {
        "question": "Какая из перечисленных горных пород является осадочной?",
        "options": ['Торф', 'Гранит', 'Кварцит', 'Мрамор'],
        "right": '1',
    },
    {
        "question": "Нормальное атмосферное давление на уровне моря составляет",
        "options": ['740 мм рт. ст.', '750 мм рт. ст.', '760 мм рт. ст.', '770 мм рт. ст.'],
        "right": '3',
    },
    {
        "question": "Территория какой из перечисленных стран имеет наибольшую площадь?",
        "options": ['Австралия', 'Канада', 'Китай', 'США'],
        "right": '2',
    },
    {
        "question": "На какой газ приходится наибольшая доля в составе воздуха атмосферы?",
        "options": ['азот', 'водород', 'кислород', 'углекислый газ'],
        "right": '1',
    },
    {
        "question": "Какое из перечисленных океанических течений холодное?",
        "options": ['Перуанское', 'Гольфстрим', 'Бразильское', 'Гвинейское'],
        "right": '1',
    },
]
        await ask_que(update, context)
    else:
        await query.answer()
        right_ans = questions[que_num]["right"]

        if data == right_ans:
            await query.message.reply_text("Верно!")
            right += 1
        else:
            await query.message.reply_text("Неверно!")
        index += 1
        questions.pop(que_num)
        await ask_que(update, context)


async def biology(update, context):
    global questions
    button2 = InlineKeyboardButton(text='Готов', callback_data="ready_bio")
    buttons = InlineKeyboardMarkup(inline_keyboard=[[button2]])
    await update.message.reply_text(
        'Готов ли ты пройти тест по биологии?', reply_markup=buttons)


async def chemistry(update, context):
    global questions
    button2 = InlineKeyboardButton(text='Готов', callback_data="ready_chem")
    buttons = InlineKeyboardMarkup(inline_keyboard=[[button2]])
    await update.message.reply_text(
        'Готов ли ты пройти тест по химии?', reply_markup=buttons)


async def obsh(update, context):
    global questions
    button2 = InlineKeyboardButton(text='Готов', callback_data="ready_obsh")
    buttons = InlineKeyboardMarkup(inline_keyboard=[[button2]])
    await update.message.reply_text(
        'Готов ли ты пройти тест по обществознанию?', reply_markup=buttons)


async def geo(update, context):
    global questions
    button2 = InlineKeyboardButton(text='Готов', callback_data="ready_geo")
    buttons = InlineKeyboardMarkup(inline_keyboard=[[button2]])
    await update.message.reply_text(
        'Готов ли ты пройти тест по географии?', reply_markup=buttons)


def main():
    application = Application.builder().token('7139029616:AAFr6rxBN7yZzKyHjxLQEkfNqazSUEbOBJQ').build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("biology", biology))
    application.add_handler(CommandHandler("chemistry", chemistry))
    application.add_handler(CommandHandler("obshestvo", obsh))
    application.add_handler(CommandHandler("geography", geo))

    application.add_handler(CallbackQueryHandler(handle_button_click))

    application.run_polling()


reply_keyboard = [['/biology', '/chemistry', '/obshestvo'],
                  ['/geography', '/help']]
markup = ReplyKeyboardMarkup(reply_keyboard, one_time_keyboard=False)


if __name__ == '__main__':
    main()
